# Xiaomi Temperature and Humidity

*Modified 2022-01-12*

- [Xiaomi Temperature and Humidity](#xiaomi-temperature-and-humidity)
  - [BOM](#bom)
  - [Upload new firmware to the sensors](#upload-new-firmware-to-the-sensors)
  - [Gateway setup](#gateway-setup)
    - [Naming conventions, MQTT topics](#naming-conventions-mqtt-topics)
    - [Board firmware](#board-firmware)
  - [References](#references)

Also known as ``LYWSD03MMC``, cheap and affordable Temperature and Humidity sensor with bluetooth connectivity and LCD display.

An ESP32 board will act as bluetooth gateway that collects data from the sensors and send it to the server via MQTT.

## BOM

| Name | QTY | Price â‚¬ | Notes |
|:-----|:---:|--------:|:------|
| LYWSD03MMC Xiaomi Temperature and Humidity | 4  |    | [XIAOMI Mijia Bluetooth Thermometer 2](https://www.aliexpress.com/item/1005001723129052.html?spm=a2g0o.9042311.0.0.74464c4d0lSabq) |
| ESP32 board                                | 1  | 16 | [ESP32 ESP-32 Development Board](https://www.aliexpress.com/item/1005001929935550.html?spm=a2g0o.9042311.0.0.74464c4d0lSabq) | 

!> TODO<br>
  Should design and 3D print a tray and mount the gateway into the server rack.

## Upload new firmware to the sensors

1. Open the WebFlasher [TelinkFlasher](https://atc1441.github.io/TelinkFlasher.html).
2. Go to Github repo [atc1441/ATC_MiThermometer](https://github.com/atc1441/ATC_MiThermometer) and download the latest ``.bin`` file from the releases section.
3. Click on ``connect`` and choose the sensor, name may start like LYWSD03MMC..
4. Once connected, push ``Do Activation``.
5. Select Firmware and upload the downloaded bin file.
6. Press ``Start Flashing``.
7. When is done, connect again and select ``custom`` for ``Advertising Type``, [more details](https://github.com/esphome/feature-requests/issues/552#issuecomment-688049747).

Once its done, you may try connecting again and play with the settings, note that the name of the device will start with ``ATC_last6macDigits``.

## Gateway setup

ESPHome generated by default template uses the home assistant native API, but I prefer using MQTT over it, so having a much more control and not depend on home assistant.<br>
Add a new device from the WEB UI and copy/paste the ``.yaml`` configuration below.<br>
Under the ``sensor`` section, change the ``mac_address`` value with yours.<br>
You may retrieve the MAC address of the devices either trying to pair or restart it, in both cases you will get last 6 digits of the MAC address.
If using the first case (pairing), the name of the device includes them, should be something like ATC_last6macDigits. 

### Naming conventions, MQTT topics

Inspired by CQRS pattern, stands for Command Query Responsibility Segregation.<br>
In few words pattern separate the requests as commands (change state of an entity) and queries (read state of an entity).<br>
So the MQTT topics are divided into a two types.
- Query, available queries can be - ``state``, ``status``, etc..
- Command, available commands are - ``set``

The pattern I came up with:
- ``deviceId/subDeviceId/cqrs/domainEntity/`` (if having a gateway)
- ``deviceId/cqrs/domainEntity/`` (without gateway)

So for example, we may have topics like:

| Topic | Description |
|:------|:------------|
| ``gateway-ble/atc5A9381/state/temperature`` | pub/sub readings of temperature |
| ``gateway-ble/atc5A9381/state/humidity`` | pub/sub readings of humidity |
| ``gateway-ble/atc5A9381/set/relay1`` | pub/sub set of the relay 1 |

In that way, would be easy for creating an ETL service with wild cards.<br>
For example you may subscribe for all temperature measurements ``gateway-ble/#/state/temperature``, or
bulk set of the relay 1 for all the devices ``gateway-ble/#/set/relay1``.

### Board firmware

``gateway-ble.yaml``
```yml
substitutions:
  device_name: gateway-ble

esphome:
  name: $device_name

esp32:
  board: esp-wrover-kit
  framework:
    type: arduino

# Enable logging
logger:
  # level: DEBUG

# Enable Home Assistant API
#api:

ota:
  password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  fast_connect: true

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: Fallback $device_name
    password: !secret ap_password

captive_portal:

# Web server section
web_server:
  port: 80
  auth:
    username: admin
    password: !secret web_server_password

# MQTT configuration
mqtt:
  broker: !secret mqtt_broker
  username: !secret mqtt_username
  password: !secret mqtt_password
  port: !secret mqtt_port
  client_id: $device_name
  # Set to true when finished testing to set MQTT retain flag
  discovery_retain: true

esp32_ble_tracker:

status_led:
  pin: GPIO2

# text_sensor:
#   - platform: template
#     name: Uptime Human Readable
#     id: uptime_human
#     icon: mdi:clock-start
#     state_topic: $mqtt_main_topic/uptime_text

sensor:
  - platform: atc_mithermometer
    mac_address: "A4:C1:38:5A:93:81"
    id: ATC5A9381
    temperature:
      name: "ATC5A9381 Temperature"
      state_topic: $device_name/ATC5A9381/state/temperature
    humidity:
      name: "ATC5A9381 Humidity"
      state_topic: $device_name/ATC5A9381/state/humidity
    battery_level:
      name: "ATC5A9381 Battery-Level"
      state_topic: $device_name/ATC5A9381/state/battery-level
    battery_voltage:
      name: "ATC5A9381 Battery-Voltage"
      state_topic: $device_name/ATC5A9381/state/battery-voltage

  - platform: atc_mithermometer
    mac_address: "A4:C1:38:94:35:F2"
    id: ATC9435F2
    temperature:
      name: "ATC9435F2 Temperature"
      state_topic: $device_name/ATC9435F2/state/temperature
    humidity:
      name: "ATC9435F2 Humidity"
      state_topic: $device_name/ATC9435F2/state/humidity
    battery_level:
      name: "ATC9435F2 Battery-Level"
      state_topic: $device_name/ATC9435F2/state/battery-level
    battery_voltage:
      name: "ATC9435F2 Battery-Voltage"
      state_topic: $device_name/ATC9435F2/state/battery-voltage

  - platform: atc_mithermometer
    mac_address: "A4:C1:38:22:76:4B"
    id: ATC22764B
    temperature:
      name: "ATC22764B Temperature"
      state_topic: $device_name/ATC22764B/state/temperature
    humidity:
      name: "ATC22764B Humidity"
      state_topic: $device_name/ATC22764B/state/humidity
    battery_level:
      name: "ATC22764B Battery-Level"
      state_topic: $device_name/ATC22764B/state/battery-level
    battery_voltage:
      name: "ATC22764B Battery-Voltage"
      state_topic: $device_name/ATC22764B/state/battery-voltage

  - platform: atc_mithermometer
    mac_address: "A4:C1:38:12:8B:07"
    id: ATC128B07
    temperature:
      name: "ATC128B07 Temperature"
      state_topic: $device_name/ATC128B07/state/temperature
    humidity:
      name: "ATC128B07 Humidity"
      state_topic: $device_name/ATC128B07/state/humidity
    battery_level:
      name: "ATC128B07 Battery-Level"
      state_topic: $device_name/ATC128B07/state/battery-level
    battery_voltage:
      name: "ATC128B07 Battery-Voltage"
      state_topic: $device_name/ATC128B07/state/battery-voltage
```

``secrets.yaml``
```yaml
wifi_ssid: "yourCredentials"
wifi_password: "yourCredentials"
ap_password: "yourCredentials"
ota_password: "yourCredentials"
mqtt_broker: "brokerUrl/IP"
mqtt_port: 1883
mqtt_username: "" # Leave it like this if no credentials for the broker
mqtt_password: ""
web_server_password: "yourCredentials"
```
  
## References

- [4$ Xiaomi thermometer custom firmware LYWSD03MMC BLE TLSR8251](https://www.youtube.com/watch?v=NXKzFG61lNs)<br>
  YouTube, explains how to flash the sensors with a customer firmware, atc's Telink.
- [Super easy! Add your ESP32 Board to Home Assistant with ESPHome.](https://www.youtube.com/watch?v=Be5zWukjV9I)<br>
  YouTube, shows how to use xiaomi temperature and humidity sensors with an ESPHome using ESP32 as bluetooth gateway, pvvx's Telink customer firmware for the xiaomi sensors used.
- [Xiaomi Mijia BLE Sensors/LYWSD03MMC](https://esphome.io/components/sensor/xiaomi_ble.html?lywsd03mmc#lywsd03mmc)<br>
  ESPHome official docs for the sensors.
